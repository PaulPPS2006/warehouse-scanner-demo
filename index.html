<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warehouse Shelf Scanner ‚Äî Demo</title>
  <!-- ZXing for barcode scanning -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg:#0b0f14; --card:#121824; --text:#e7eefb; --muted:#93a2b7; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text)}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);border-radius:16px;padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.3)}
    h1{font-size:1.4rem;margin:0 0 8px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,select,button{height:44px;border-radius:12px;border:1px solid #223044;background:#0f1622;color:var(--text);padding:0 12px;font-size:16px}
    button{cursor:pointer;border:none;background:var(--accent);color:white;font-weight:600; padding:0 16px}
    button.secondary{background:#223044}
    button.ghost{background:transparent;border:1px solid #223044}
    button.ok{background:var(--ok)}
    button.warn{background:var(--warn)}
    button.err{background:var(--err)}
    .grow{flex:1}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #223044;background:#0f1622;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    video{width:100%;border-radius:12px;background:#000}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #223044;text-align:left}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0f1622;border:1px solid #223044;color:var(--text);padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);z-index:50;display:none}
    .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .kpi .card{padding:12px}
    .kpi h3{margin:4px 0;font-size:14px;color:var(--muted)}
    .kpi p{margin:0;font-size:20px;font-weight:700}
    @media (max-width:720px){.kpi{grid-template-columns:1fr}}
    <style>\n    :root { --bg:#0b0f14; --card:#121824; --text:#e7eefb; --muted:#93a2b7; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }\n    *{box-sizing:border-box}\n    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,\"Helvetica Neue\",Arial; background:var(--bg); color:var(--text)}\n    .container{max-width:980px;margin:0 auto;padding:16px}\n    .grid{display:grid;gap:16px}\n    .card{background:var(--card);border-radius:16px;padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.3)}\n    h1{font-size:1.4rem;margin:0 0 8px}\n    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}\n    input,select,button{height:44px;border-radius:12px;border:1px solid #223044;background:#0f1622;color:var(--text);padding:0 12px;font-size:16px}\n    button{cursor:pointer;border:none;background:var(--accent);color:white;font-weight:600; padding:0 16px}\n    button.secondary{background:#223044}\n    button.ghost{background:transparent;border:1px solid #223044}\n    button.ok{background:var(--ok)}\n    button.warn{background:var(--warn)}\n    button.err{background:var(--err)}\n    .grow{flex:1}\n    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #223044;background:#0f1622;color:var(--muted);font-size:12px}\n    .muted{color:var(--muted)}\n    video{width:100%;border-radius:12px;background:#000}\n    table{width:100%;border-collapse:collapse}\n    th,td{padding:10px;border-bottom:1px solid #223044;text-align:left}\n    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0f1622;border:1px solid #223044;color:var(--text);padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);z-index:50;display:none}\n    .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}\n    .kpi .card{padding:12px}\n    .kpi h3{margin:4px 0;font-size:14px;color:var(--muted)}\n    .kpi p{margin:0;font-size:20px;font-weight:700}\n    @media (max-width:720px){.kpi{grid-template-columns:1fr}}\n    .status{margin-top:8px; font-size:12px; color:var(--muted)}\n    .status.ok{color:#8be28b}\n    .status.err{color:#ff8a8a}\n  </style>\n</head>
<body>
  <div class="container grid">
    <header class="card">
      <h1>üì¶ Warehouse Shelf Scanner ‚Äî Demo</h1>
      <p class="muted">Scan retail-style barcodes with your phone camera. Add/Remove to shelves, view live inventory, and download to Excel. Data is stored in your browser (localStorage) for the demo.</p>
      <div class="kpi">
        <div class="card"><h3>Total Shelves</h3><p id="kpi-shelves">0</p></div>
        <div class="card"><h3>Total Items</h3><p id="kpi-items">0</p></div>
        <div class="card"><h3>Unique SKUs</h3><p id="kpi-skus">0</p></div>
      </div>
    </header>

    <section class="card">
      <div class="row" style="gap:8px 12px">
        <select id="mode">
          <option value="add">Add</option>
          <option value="remove">Remove</option>
        </select>
        <input id="shelf" class="grow" placeholder="Shelf ID (e.g., A1, B3). Optional for Remove." />
        <button id="scanBtn">Start Scanner</button>
        <button id="stopBtn" class="secondary">Stop</button>
        <button id="manualBtn" class="ghost">Manual Entry</button>
      </div>
      <div id=\"videoWrap\" style=\"margin-top:12px;display:none\">\n        <video id=\"video\" muted playsinline></video>\n        <div class=\"row\" style=\"margin-top:8px\">\n          <span class=\"pill\" id=\"camInfo\">Camera: ‚Äî</span>\n          <span class=\"pill\" id=\"lastScan\">Last scan: ‚Äî</span>\n        </div>\n        <p id=\"camStatus\" class=\"status\">Camera status: not started.</p>\n      </div>\n    </section>

    <section class="card">
      <div class="row">
        <button id="downloadXLSX" class="ok">Download Excel (.xlsx)</button>
        <button id="downloadCSV" class="secondary">Download CSV</button>
        <button id="clearAll" class="err">‚ö†Ô∏è Clear Demo Data</button>
      </div>
      <p class="muted" style="margin-top:8px">Excel shows the <em>current inventory</em> by Shelf ‚Üí SKU ‚Üí Quantity. A separate sheet includes the full activity log.</p>
    </section>

    <section class="card">
      <h2 style="margin-top:0">Live Inventory</h2>
      <div id="inventoryTable"></div>
    </section>

    <section class="card">
      <h2 style="margin-top:0">Activity Log</h2>
      <div id="logTable"></div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

<script>
// ===== Persistence (localStorage) =====
const STORAGE_KEY = 'warehouse_demo_v1';
const state = loadState();

function loadState(){
  try{ const raw = localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw): { shelves:{}, log:[] }; }catch(e){ return { shelves:{}, log:[] }; }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); render();\n// On iOS Safari, audio policy requires a user gesture; our Start button handles this. }

// ===== Helpers =====
const $ = sel => document.querySelector(sel);
function toast(msg, tone="info"){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 1800); }
function ts(){ return new Date().toISOString(); }

// ===== Inventory Ops =====
function addItem(shelf, code){
  if(!shelf){ toast('Enter Shelf ID first (e.g., A1).', 'warn'); return; }
  shelf = shelf.trim().toUpperCase();
  if(!state.shelves[shelf]) state.shelves[shelf] = {};
  state.shelves[shelf][code] = (state.shelves[shelf][code]||0)+1;
  state.log.unshift({t:ts(), action:'ADD', shelf, code});
  saveState();
  toast(`Added ${code} ‚Üí shelf ${shelf}`);
}
function removeItem(code, shelfHint){
  // If shelf specified, try there first; otherwise search all shelves
  const tryShelves = shelfHint? [shelfHint.trim().toUpperCase()] : Object.keys(state.shelves);
  for(const s of tryShelves){
    const shelfMap = state.shelves[s];
    if(shelfMap && shelfMap[code]>0){
      shelfMap[code] -= 1;
      if(shelfMap[code]===0) delete shelfMap[code];
      if(Object.keys(shelfMap).length===0) delete state.shelves[s];
      state.log.unshift({t:ts(), action:'REMOVE', shelf:s, code});
      saveState();
      toast(`Removed ${code} from shelf ${s}`);
      return true;
    }
  }
  toast(`Item ${code} not found.`, 'warn');
  return false;
}

// ===== Rendering =====
function renderKPIs(){
  const shelves = Object.keys(state.shelves);
  const uniqueSKUs = new Set();
  let total = 0;
  shelves.forEach(s=>{ const m=state.shelves[s]; Object.entries(m).forEach(([k,v])=>{ uniqueSKUs.add(k); total += v; }); });
  $('#kpi-shelves').textContent = shelves.length;
  $('#kpi-items').textContent = total;
  $('#kpi-skus').textContent = uniqueSKUs.size;
}

function renderInventory(){
  const wrap = $('#inventoryTable');
  const rows = [];
  Object.keys(state.shelves).sort().forEach(shelf=>{
    const items = state.shelves[shelf];
    Object.keys(items).sort().forEach(code=>{
      rows.push({shelf, code, qty: items[code]});
    });
  });
  if(!rows.length){ wrap.innerHTML = '<p class="muted">No items yet. Use the scanner to add items.</p>'; return; }
  let html = '<table><thead><tr><th>Shelf</th><th>Barcode</th><th>Qty</th></tr></thead><tbody>';
  rows.forEach(r=>{ html += `<tr><td>${r.shelf}</td><td>${r.code}</td><td>${r.qty}</td></tr>`; });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

function renderLog(){
  const wrap = $('#logTable');
  if(state.log.length===0){ wrap.innerHTML = '<p class="muted">No activity yet.</p>'; return; }
  let html = '<table><thead><tr><th>Time (UTC)</th><th>Action</th><th>Shelf</th><th>Barcode</th></tr></thead><tbody>';
  state.log.slice(0,200).forEach(r=>{ html += `<tr><td>${r.t}</td><td>${r.action}</td><td>${r.shelf||''}</td><td>${r.code}</td></tr>`; });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

function render(){ renderKPIs(); renderInventory(); renderLog(); }

// ===== Barcode Scanner (ZXing) =====\nlet codeReader = null; let currentDeviceId = null; let scanning = false;\n\nasync function ensureCameraPermission(){\n  try{\n    const s = await navigator.permissions?.query?.({name:'camera'}).catch(()=>null);\n    // iOS Safari doesn't support Permissions API; fallback to getUserMedia prompt\n    if(!s || s.state !== 'granted'){\n      $('#camStatus').textContent = 'Requesting camera permission‚Ä¶';\n      await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });\n      $('#camStatus').textContent = 'Camera permission granted.';\n    } else {\n      $('#camStatus').textContent = 'Camera permission already granted.';\n    }\n    return true;\n  } catch(e){\n    console.error('Permission error', e);\n    $('#camStatus').textContent = 'Camera permission denied or unavailable. Check browser settings.';\n    toast('Camera blocked. Allow camera in site settings.', 'err');\n    return false;\n  }\n}\n\nasync function startScanner(){\n  if(scanning) return;\n  if(!('mediaDevices' in navigator)){ toast('Camera API not supported on this device.', 'err'); return; }\n  const ok = await ensureCameraPermission();\n  if(!ok) return;\n  try{\n    codeReader = new ZXing.BrowserMultiFormatReader();\n    const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();\n    let back = devices.find(d=>/back|rear|environment/i.test(d.label));\n    if(!back && devices[0]) back = devices[0];\n    currentDeviceId = back?.deviceId || undefined;\n    $('#camInfo').textContent = back? `Camera: ${back.label||'Default'}` : 'Camera: default';\n    $('#videoWrap').style.display = 'block';\n    $('#camStatus').textContent = 'Scanner running‚Ä¶';\n    scanning = true;\n\n    if(currentDeviceId){\n      codeReader.decodeFromVideoDevice(currentDeviceId, '#video', onScanCB);\n    } else {\n      // Fallback: constraints without explicit deviceId (helps on iOS)\n      codeReader.decodeFromConstraints({\n        video: { facingMode: { ideal: 'environment' } },\n        audio: false\n      }, '#video', onScanCB);\n    }\n  }catch(e){ \n    console.error(e); \n    $('#camStatus').textContent = 'Camera error. Check permissions and reload.';\n    toast('Camera error. Check permissions.', 'err'); \n  }\n}\nfunction onScanCB(result, err){\n  if(result){\n    const text = result.getText();\n    $('#lastScan').textContent = `Last scan: ${text}`;\n    handleScan(text);\n  } else if(err && !(err instanceof ZXing.NotFoundException)){\n    // NotFound is expected while scanning; log other errors\n    console.warn(err);\n  }\n}\n\nfunction stopScanner(){ if(codeReader){ codeReader.reset(); codeReader = null; } scanning=false; $('#camStatus').textContent = 'Scanner stopped.'; }\n\n// ===== Manual Entry =====
function manualEntry(){
  const code = prompt('Enter/scan the barcode value:');
  if(!code) return;
  const mode = $('#mode').value;
  const shelf = $('#shelf').value.trim();
  if(mode==='add') addItem(shelf, code);
  else removeItem(code, shelf||undefined);
}

// ===== Downloads =====
function toInventoryRows(){
  const rows = [];
  Object.keys(state.shelves).sort().forEach(shelf=>{
    const items = state.shelves[shelf];
    Object.keys(items).sort().forEach(code=>{
      rows.push({Shelf:shelf, Barcode:code, Quantity:items[code]});
    });
  });
  return rows;
}

function downloadCSV(){
  const rows = toInventoryRows();
  if(rows.length===0){ toast('No inventory to export.', 'warn'); return; }
  const headers = Object.keys(rows[0]);
  const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>`"${String(r[h]).replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `inventory_${new Date().toISOString().slice(0,19)}.csv`; a.click();
}

function downloadXLSX(){
  const inv = toInventoryRows();
  const log = state.log.map(r=>({Time:r.t, Action:r.action, Shelf:r.shelf||'', Barcode:r.code}));
  if(inv.length===0 && log.length===0){ toast('Nothing to export yet.', 'warn'); return; }
  const wb = XLSX.utils.book_new();
  if(inv.length){ const ws1 = XLSX.utils.json_to_sheet(inv); XLSX.utils.book_append_sheet(wb, ws1, 'Inventory'); }
  if(log.length){ const ws2 = XLSX.utils.json_to_sheet(log); XLSX.utils.book_append_sheet(wb, ws2, 'Activity Log'); }
  XLSX.writeFile(wb, `warehouse_${new Date().toISOString().slice(0,19)}.xlsx`);
}

// ===== UI bindings =====
$('#scanBtn').addEventListener('click', startScanner);
$('#stopBtn').addEventListener('click', stopScanner);
$('#manualBtn').addEventListener('click', manualEntry);
$('#downloadCSV').addEventListener('click', downloadCSV);
$('#downloadXLSX').addEventListener('click', downloadXLSX);
$('#clearAll').addEventListener('click', ()=>{ if(confirm('Clear all demo data?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });

render();
</script>
</body>
</html>

